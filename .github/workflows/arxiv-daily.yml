name: Daily Arxiv Report

on:
  workflow_dispatch:
  schedule:
    - cron: '0 1 * * *'

jobs:
  build-and-publish-report:
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: read

    # 将项目根目录下的 src 加入 PYTHONPATH，适用于所有 steps
    env:
      PYTHONPATH: ${{ github.workspace }}/src
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
      ANALYZER_MODEL: ${{ secrets.ANALYZER_MODEL }}
      MAX_FIGURE_NUM: ${{ secrets.MAX_FIGURE_NUM }}
      JUDGER_MODEL: ${{ secrets.JUDGER_MODEL }}
      RESEARCH_PREFER: ${{ secrets.RESEARCH_PREFER }}
      RESEARCH_NOT_PREFER: ${{ secrets.RESEARCH_NOT_PREFER }}
      PREFER_CATEGORY: ${{ secrets.PREFER_CATEGORY }}

    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4

      - name: 2. Set up Python
        uses: actions/setup-python@v6
        with:
          python-version-file: ".python-version"

      - name: 3. Install uv
        uses: astral-sh/setup-uv@v6

      - name: 4. Install dependencies with uv
        run: uv sync --locked --all-extras

      - name: 5. Run githubPublish.py script
        run: uv run python -m scripts.githubPublish

      - name: 6. Get today's report path
        id: get_path
        run: |
          set -e
          md_path="$(uv run python -m scripts.getTodayPath)"
          if [ -z "$md_path" ]; then
            echo "Error: getTodayPath.py returned empty path" >&2
            exit 1
          fi
          echo "md_path=$md_path" >> $GITHUB_OUTPUT

      - name: 7. Check if report file exists
        id: check_file
        run: |
          set -e
          MD_FILE_PATH="${{ steps.get_path.outputs.md_path }}"
          echo "Checking for file: $MD_FILE_PATH"
          if [ -f "$MD_FILE_PATH" ]; then
            echo "Report file found. Proceeding."
            ISSUE_TITLE=$(basename "$MD_FILE_PATH")
            echo "issue_title=$ISSUE_TITLE" >> $GITHUB_OUTPUT
          else
            echo "Error: Report file not found at $MD_FILE_PATH" >&2
            exit 1
          fi

      - name: 8. Create GitHub Issue
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: ${{ steps.check_file.outputs.issue_title }}
          content-filepath: ${{ steps.get_path.outputs.md_path }}
          labels: arxiv-report, automated
